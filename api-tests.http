### SQL Analyzer API 测试用例集合
### 使用 Rest Client 插件进行测试
### API 基础地址: http://localhost:3000

@baseUrl = http://localhost:3000
@contentType = application/json

### =====================================================
### 1. 系统健康检查
### =====================================================

### 1.1 简单Ping检查
GET {{baseUrl}}/api/health/ping

### 1.2 完整健康检查
GET {{baseUrl}}/api/health

### 1.3 特定组件健康检查 - 数据库
GET {{baseUrl}}/api/health/check/database

### 1.4 特定组件健康检查 - 内存
GET {{baseUrl}}/api/health/check/memory

### 1.5 获取系统状态
GET {{baseUrl}}/api/status

### =====================================================
### 2. 配置管理
### =====================================================

### 2.1 获取所有配置
GET {{baseUrl}}/api/config

### 2.2 获取配置模块列表
GET {{baseUrl}}/api/config/modules

### 2.3 获取指定配置项 - LLM配置
GET {{baseUrl}}/api/config/llm

### 2.4 获取指定配置项 - 数据库配置
GET {{baseUrl}}/api/config/database

### 2.5 更新配置项 - 设置LLM温度
PUT {{baseUrl}}/api/config/llm.temperature
Content-Type: {{contentType}}

{
  "value": 0.3
}

### =====================================================
### 3. SQL分析核心功能
### =====================================================

### 3.1 单条SQL分析 - 性能分析
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users WHERE email = 'test@example.com'",
  "databaseType": "mysql",
  "options": {
    "performance": true,
    "security": false,
    "standards": false
  }
}

### 3.2 单条SQL分析 - 安全分析
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users WHERE id = " + userInput,
  "databaseType": "mysql",
  "options": {
    "performance": false,
    "security": true,
    "standards": false
  }
}

### 3.3 单条SQL分析 - 标准规范检查
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "select * from users where name like '%test%'",
  "databaseType": "mysql",
  "options": {
    "performance": false,
    "security": false,
    "standards": true
  }
}

### 3.4 单条SQL分析 - 综合分析
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT u.name, p.title FROM users u JOIN posts p ON u.id = p.user_id WHERE u.active = 1 ORDER BY p.created_at DESC LIMIT 10",
  "databaseType": "postgresql",
  "options": {
    "performance": true,
    "security": true,
    "standards": true,
    "learn": true
  }
}

### 3.5 复杂SQL分析
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "WITH user_stats AS (SELECT user_id, COUNT(*) as post_count, MAX(created_at) as last_post FROM posts WHERE created_at > '2024-01-01' GROUP BY user_id HAVING COUNT(*) > 5) SELECT u.name, us.post_count, us.last_post FROM user_stats us JOIN users u ON us.user_id = u.id WHERE u.status = 'active'",
  "databaseType": "postgresql",
  "options": {
    "performance": true,
    "security": true,
    "standards": true
  }
}

### 3.6 批量SQL分析
POST {{baseUrl}}/api/analyze/batch
Content-Type: {{contentType}}

{
  "sqls": [
    "SELECT * FROM users WHERE id = 1",
    "SELECT COUNT(*) FROM orders WHERE status = 'pending'",
    "UPDATE users SET last_login = NOW() WHERE id = 1"
  ],
  "databaseType": "mysql",
  "options": {
    "performance": true,
    "security": true,
    "standards": false
  }
}

### 3.7 批量SQL分析 - 复杂格式
POST {{baseUrl}}/api/analyze/batch
Content-Type: {{contentType}}

{
  "sqls": [
    {
      "sql": "SELECT u.name, COUNT(o.id) as order_count FROM users u LEFT JOIN orders o ON u.id = o.user_id GROUP BY u.id"
    },
    {
      "sql": "DELETE FROM sessions WHERE expires_at < NOW()"
    }
  ],
  "databaseType": "postgresql",
  "options": {
    "performance": true,
    "security": true,
    "standards": true
  }
}

### 3.8 获取分析器状态
GET {{baseUrl}}/api/analyze/status

### =====================================================
### 4. 知识库管理
### =====================================================

### 4.1 获取知识库状态
GET {{baseUrl}}/api/knowledge

### 4.2 搜索知识库 - 性能优化相关
POST {{baseUrl}}/api/knowledge/search
Content-Type: {{contentType}}

{
  "query": "index optimization slow query",
  "limit": 10
}

### 4.3 搜索知识库 - 安全相关
POST {{baseUrl}}/api/knowledge/search
Content-Type: {{contentType}}

{
  "query": "SQL injection prevention",
  "limit": 5
}

### 4.4 学习新文档（需要提供rules目录路径）
POST {{baseUrl}}/api/knowledge/learn
Content-Type: {{contentType}}

{
  "rulesDirectory": "./rules",
  "forceRebuild": true
}

### 4.5 导出知识库
GET {{baseUrl}}/api/knowledge/export

### 4.6 重置知识库
POST {{baseUrl}}/api/knowledge/reset

### =====================================================
### 5. 规则学习系统
### =====================================================

### 5.1 获取规则学习配置
GET {{baseUrl}}/api/rule-learning/config

### 5.2 更新规则学习配置
PUT {{baseUrl}}/api/rule-learning/config
Content-Type: {{contentType}}

{
  "enabled": true,
  "autoThresholdAdjustment": true,
  "minConfidence": 0.7,
  "minSimilarity": 0.8,
  "maxRulesPerCategory": 100,
  "learningRate": 0.1,
  "forgettingFactor": 0.95
}

### 5.3 重置规则学习配置
POST {{baseUrl}}/api/rule-learning/config/reset

### 5.4 获取规则学习状态
GET {{baseUrl}}/api/rule-learning/status

### 5.5 触发批量规则学习
POST {{baseUrl}}/api/rule-learning/learn
Content-Type: {{contentType}}

{
  "sourceDirectory": "./history",
  "analysisTypes": ["performance", "security", "standards"],
  "options": {
    "minConfidence": 0.8,
    "maxRules": 50,
    "categoryFilter": ["performance", "security"]
  }
}

### 5.6 获取智能阈值调整统计
GET {{baseUrl}}/api/rule-learning/threshold-stats

### =====================================================
### 6. 历史记录管理
### =====================================================

### 6.1 获取历史记录统计信息
GET {{baseUrl}}/api/history/stats

### 6.2 获取历史记录列表
GET {{baseUrl}}/api/history?limit=10&offset=0

### 6.3 搜索历史记录 - 按SQL内容
POST {{baseUrl}}/api/history/search
Content-Type: {{contentType}}

{
  "query": "SELECT",
  "analysisTypes": ["performance"],
  "dateRange": {
    "start": "2024-01-01",
    "end": "2024-12-31"
  },
  "limit": 20
}

### 6.4 搜索历史记录 - 按分析类型
POST {{baseUrl}}/api/history/search
Content-Type: {{contentType}}

{
  "analysisTypes": ["security", "standards"],
  "minScore": 60,
  "limit": 15
}

### 6.5 获取指定历史记录详情
# 注意：需要替换 :id 为实际的记录ID
GET {{baseUrl}}/api/history/123

### 6.6 导出历史记录
GET {{baseUrl}}/api/history/export?format=json&dateRange=30d

### 6.7 删除指定历史记录
# 注意：需要替换 :id 为实际的记录ID
DELETE {{baseUrl}}/api/history/123

### 6.8 清空所有历史记录
DELETE {{baseUrl}}/api/history

### =====================================================
### 7. 错误处理和边界测试
### =====================================================

### 7.1 无效的SQL语法
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELCT * FROM users WHERE",  # 故意的语法错误
  "databaseType": "mysql",
  "options": {
    "performance": true
  }
}

### 7.2 不支持的数据库类型
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users",
  "databaseType": "unsupported_db",
  "options": {
    "performance": true
  }
}

### 7.3 空的SQL语句
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "",
  "databaseType": "mysql",
  "options": {
    "performance": true
  }
}

### 7.4 超长的SQL语句
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users WHERE " + "a".repeat(10000),
  "databaseType": "mysql",
  "options": {
    "performance": true
  }
}

### 7.5 无效的配置项
PUT {{baseUrl}}/api/config/invalid.key
Content-Type: {{contentType}}

{
  "value": "test"
}

### 7.6 无效的分析选项
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users",
  "databaseType": "mysql",
  "options": {
    "invalid_option": true
  }
}

### 7.7 批量分析超过限制
POST {{baseUrl}}/api/analyze/batch
Content-Type: {{contentType}}

{
  "sqls": [
    "SELECT 1",
    "SELECT 2",
    "SELECT 3",
    "SELECT 4",
    "SELECT 5",
    "SELECT 6",
    "SELECT 7",
    "SELECT 8",
    "SELECT 9",
    "SELECT 10",
    "SELECT 11"
  ],
  "databaseType": "mysql",
  "options": {
    "performance": true
  }
}

### =====================================================
### 8. 性能测试
### =====================================================

### 8.1 并发请求模拟 - 快速连续请求
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT COUNT(*) FROM users WHERE status = 'active'",
  "databaseType": "mysql",
  "options": {
    "performance": true
  }
}

###
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT COUNT(*) FROM orders WHERE created_at > '2024-01-01'",
  "databaseType": "mysql",
  "options": {
    "performance": true
  }
}

###
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT COUNT(*) FROM products WHERE category = 'electronics'",
  "databaseType": "mysql",
  "options": {
    "performance": true
  }
}

### =====================================================
### 9. 真实业务场景测试
### =====================================================

### 9.1 电商查询 - 订单统计
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT u.username, COUNT(o.id) as order_count, SUM(o.total_amount) as total_spent FROM users u LEFT JOIN orders o ON u.id = o.user_id WHERE o.created_at >= '2024-01-01' GROUP BY u.id, u.username HAVING COUNT(o.id) > 5 ORDER BY total_spent DESC",
  "databaseType": "mysql",
  "options": {
    "performance": true,
    "security": true,
    "standards": true
  }
}

### 9.2 社交媒体查询 - 动态获取
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT p.content, u.username, p.created_at, COUNT(l.id) as like_count FROM posts p JOIN users u ON p.user_id = u.id LEFT JOIN likes l ON p.id = l.post_id WHERE p.created_at > NOW() - INTERVAL '7 days' GROUP BY p.id ORDER BY like_count DESC LIMIT 20",
  "databaseType": "postgresql",
  "options": {
    "performance": true,
    "security": true,
    "standards": true
  }
}

### 9.3 日志分析查询
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT DATE(created_at) as date, COUNT(*) as log_count, SUM(CASE WHEN level = 'ERROR' THEN 1 ELSE 0 END) as error_count FROM application_logs WHERE created_at BETWEEN '2024-11-01' AND '2024-11-30' GROUP BY DATE(created_at) ORDER BY date DESC",
  "databaseType": "mysql",
  "options": {
    "performance": true,
    "standards": true
  }
}

### 9.4 财务报表查询
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "WITH monthly_revenue AS (SELECT DATE_FORMAT(order_date, '%Y-%m') as month, SUM(amount) as revenue FROM orders WHERE status = 'completed' GROUP BY DATE_FORMAT(order_date, '%Y-%m')), monthly_costs AS (SELECT DATE_FORMAT(expense_date, '%Y-%m') as month, SUM(amount) as cost FROM expenses GROUP BY DATE_FORMAT(expense_date, '%Y-%m')) SELECT mr.month, mr.revenue, COALESCE(mc.cost, 0) as cost, mr.revenue - COALESCE(mc.cost, 0) as profit FROM monthly_revenue mr LEFT JOIN monthly_costs mc ON mr.month = mc.month ORDER BY mr.month DESC LIMIT 12",
  "databaseType": "mysql",
  "options": {
    "performance": true,
    "security": false,
    "standards": true
  }
}

### =====================================================
### 10. 安全测试用例
### =====================================================

### 10.1 SQL注入测试 - Union注入
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users WHERE id = 1 UNION SELECT username, password, email FROM admin_users",
  "databaseType": "mysql",
  "options": {
    "security": true,
    "performance": false,
    "standards": false
  }
}

### 10.2 SQL注入测试 - 盲注
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM products WHERE category = '" + userInput + "' AND SLEEP(5)",
  "databaseType": "mysql",
  "options": {
    "security": true,
    "performance": false,
    "standards": false
  }
}

### 10.3 权限提升风险
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM sensitive_data WHERE user_id = " + userId,
  "databaseType": "postgresql",
  "options": {
    "security": true,
    "performance": false,
    "standards": false
  }
}

### 10.4 敏感信息泄露
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT u.*, p.*, s.* FROM users u JOIN profiles p ON u.id = p.user_id JOIN social_security s ON u.id = s.user_id WHERE u.email = 'test@example.com'",
  "databaseType": "mysql",
  "options": {
    "security": true,
    "standards": true
  }
}

### =====================================================
### 使用说明
### =====================================================
#
# 1. 确保API服务器运行在 http://localhost:3000
# 2. 在VS Code中安装REST Client插件
# 3. 点击请求上方的"Send Request"按钮
# 4. 或者使用快捷键 Ctrl+Alt+R (Windows/Linux) 或 Cmd+Alt+R (Mac)
#
# 测试流程建议：
# 1. 先运行健康检查确保服务正常
# 2. 测试基本SQL分析功能
# 3. 测试知识库和规则学习
# 4. 测试历史记录管理
# 5. 进行错误处理和边界测试
# 6. 运行性能和真实场景测试
#
# 注意事项：
# - 某些API可能需要先初始化知识库
# - 历史记录相关的ID需要根据实际返回的数据替换
# - 批量分析可能有数量限制
# - 某些配置修改可能需要管理员权限