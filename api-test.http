### SQL Analyzer API 测试文件
### 使用 REST Client 或 Postman 进行测试

@baseUrl = http://localhost:3000
@contentType = application/json

### ========== 基础接口 ==========

### 1. API根路径 - 获取API信息
GET {{baseUrl}}

### 2. 健康检查
GET {{baseUrl}}/api/health

### 3. API文档
GET {{baseUrl}}/api/docs

### ========== 分析接口 ==========

### 4. 单条SQL分析 - 简单查询
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users WHERE id = 1",
  "options": {
    "performance": true,
    "security": true,
    "standards": true,
    "learn": false
  }
}

### 5. 单条SQL分析 - 复杂查询
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT u.*, o.* FROM users u LEFT JOIN orders o ON u.id = o.user_id WHERE u.status = 'active' ORDER BY u.created_at DESC",
  "options": {
    "performance": true,
    "security": true,
    "standards": true
  }
}

### 6. 单条SQL分析 - 有SQL注入风险的查询
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users WHERE username = '" + username + "'",
  "options": {
    "security": true
  }
}

### 7. 批量SQL分析
POST {{baseUrl}}/api/analyze/batch
Content-Type: {{contentType}}

{
  "sqls": [
    {
      "sql": "SELECT * FROM users WHERE id = 1"
    },
    {
      "sql": "SELECT COUNT(*) FROM orders"
    },
    {
      "sql": "UPDATE users SET status = 'inactive' WHERE last_login < '2023-01-01'"
    }
  ],
  "options": {
    "performance": true,
    "security": true,
    "standards": true
  }
}

### ========== 历史记录接口 ==========

### 8. 获取历史记录列表
GET {{baseUrl}}/api/history

### 9. 获取历史记录统计
GET {{baseUrl}}/api/history/stats

### 10. 获取指定历史记录详情 (需要替换实际ID)
GET {{baseUrl}}/api/history/1731758400000-abc123

### 11. 删除指定历史记录 (需要替换实际ID)
DELETE {{baseUrl}}/api/history/1731758400000-abc123

### 12. 清空所有历史记录
DELETE {{baseUrl}}/api/history

### ========== 知识库接口 ==========

### 13. 获取知识库状态
GET {{baseUrl}}/api/knowledge

### 14. 搜索知识库
POST {{baseUrl}}/api/knowledge/search
Content-Type: {{contentType}}

{
  "query": "SQL注入",
  "k": 4
}

### 15. 学习新文档
POST {{baseUrl}}/api/knowledge/learn
Content-Type: {{contentType}}

{
  "rulesDir": "./rules",
  "reset": false
}

### 16. 重置知识库
POST {{baseUrl}}/api/knowledge/reset

### 17. 评估规则质量
POST {{baseUrl}}/api/knowledge/evaluate
Content-Type: {{contentType}}

{
  "report": true,
  "rulesDir": "./rules/learning-rules"
}

### 18. 清理低质量规则
POST {{baseUrl}}/api/knowledge/cleanup
Content-Type: {{contentType}}

{
  "score": 60,
  "backup": true,
  "rulesDir": "./rules/learning-rules"
}

### ========== 配置管理接口 ==========

### 19. 获取所有配置
GET {{baseUrl}}/api/config

### 20. 获取配置项列表
GET {{baseUrl}}/api/config/list

### 21. 获取指定配置项
GET {{baseUrl}}/api/config/model

### 22. 设置配置项
PUT {{baseUrl}}/api/config/model
Content-Type: {{contentType}}

{
  "value": "gpt-4"
}

### 23. 删除配置项(恢复默认值)
DELETE {{baseUrl}}/api/config/model

### 24. 重置所有配置
POST {{baseUrl}}/api/config/reset

### ========== 系统状态接口 ==========

### 25. 获取系统状态
GET {{baseUrl}}/api/status

### 26. 获取系统状态(交互式格式)
GET {{baseUrl}}/api/status?interactive=true

### 27. 健康检查(简化版)
GET {{baseUrl}}/api/status/health

### 28. 获取知识库状态
GET {{baseUrl}}/api/status/knowledge

### 29. 获取历史记录状态
GET {{baseUrl}}/api/status/history

### ========== 初始化接口 ==========

### 30. 初始化系统
POST {{baseUrl}}/api/init
Content-Type: {{contentType}}

{
  "force": false,
  "config": {
    "knowledgeBase": {
      "enabled": true
    }
  }
}

### 31. 获取初始化状态
GET {{baseUrl}}/api/init/status

### 32. 创建目录结构
POST {{baseUrl}}/api/init/directories

### 33. 初始化配置文件
POST {{baseUrl}}/api/init/config
Content-Type: {{contentType}}

{
  "config": {
    "knowledgeBase": {
      "enabled": true
    }
  }
}

### ========== 测试场景 ==========

### 场景1: 完整的分析流程
# 1. 检查系统健康
GET {{baseUrl}}/api/health

# 2. 分析SQL
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": "SELECT * FROM users WHERE email = 'test@example.com'",
  "options": {
    "performance": true,
    "security": true,
    "standards": true
  }
}

# 3. 查看历史记录
GET {{baseUrl}}/api/history

### 场景2: 知识库管理流程
# 1. 获取知识库状态
GET {{baseUrl}}/api/knowledge

# 2. 搜索知识库
POST {{baseUrl}}/api/knowledge/search
Content-Type: {{contentType}}

{
  "query": "性能优化",
  "k": 5
}

# 3. 学习新文档
POST {{baseUrl}}/api/knowledge/learn
Content-Type: {{contentType}}

{
  "rulesDir": "./rules",
  "reset": false
}

### 场景3: 批量分析场景
POST {{baseUrl}}/api/analyze/batch
Content-Type: {{contentType}}

{
  "sqls": [
    {
      "sql": "SELECT * FROM users"
    },
    {
      "sql": "SELECT * FROM orders WHERE status = 'pending'"
    },
    {
      "sql": "DELETE FROM logs WHERE created_at < NOW() - INTERVAL 30 DAY"
    }
  ]
}

### ========== 错误测试 ==========

### 错误1: 无效的SQL
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "sql": ""
}

### 错误2: 缺少必需字段
POST {{baseUrl}}/api/analyze
Content-Type: {{contentType}}

{
  "query": "SELECT * FROM users"
}

### 错误3: 批量分析超过限制
POST {{baseUrl}}/api/analyze/batch
Content-Type: {{contentType}}

{
  "sqls": []
}

### 错误4: 访问不存在的端点
GET {{baseUrl}}/api/nonexistent