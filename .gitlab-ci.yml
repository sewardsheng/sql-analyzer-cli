# GitLab CI Configuration for SQL Security Scan

stages:
  - test
  - security

variables:
  NODE_VERSION: "18"

# åŸºç¡€é•œåƒå®šä¹‰
.image: node:${NODE_VERSION}

# ç¼“å­˜é…ç½®
cache:
  paths:
    - node_modules/

# å®‰è£…ä¾èµ–çš„åŸºç¡€ä½œä¸š
install_dependencies:
  stage: test
  script:
    - echo "ðŸ“¦ Installing dependencies..."
    - npm ci
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

# SQLå®‰å…¨æ‰«æä½œä¸š
sql_security_scan:
  stage: security
  dependencies:
    - install_dependencies
  script:
    - echo "ðŸ” Starting SQL Security Scan..."

    # æŸ¥æ‰¾SQLæ–‡ä»¶
    - |
      SQL_FILES=$(find . -type f \( -name "*.sql" -o -name "*.SQL" \) -not -path "./node_modules/*" -not -path "./.git/*" | tr '\n' ' ')
      echo "Found SQL files: $SQL_FILES"

      if [ -n "$SQL_FILES" ]; then
        # åˆ›å»ºç»“æžœç›®å½•
        mkdir -p sql-analysis-results

        # è¿è¡ŒSQLåˆ†æž
        echo "Analyzing SQL files..."
        node dist/cli/index.js analyze $SQL_FILES --format json > sql-analysis-results/scan-results.json
        node dist/cli/index.js analyze $SQL_FILES --format junit > sql-analysis-results/scan-results.xml

        # æ£€æŸ¥ç»“æžœ
        HIGH_ISSUES=$(node -e "
          const results = JSON.parse(require('fs').readFileSync('sql-analysis-results/scan-results.json', 'utf8'));
          const summary = results.scanInfo || {};
          console.log((summary.issuesBySeverity?.high || 0) + (summary.issuesBySeverity?.critical || 0));
        ")

        echo "ðŸ“Š Scan Summary:"
        echo "Critical+High Issues: $HIGH_ISSUES"

        # å¦‚æžœæœ‰ä¸¥é‡é—®é¢˜ï¼Œæž„å»ºå¤±è´¥
        if [ "$HIGH_ISSUES" -gt 0 ]; then
          echo "âŒ Found high/critical SQL security issues!"
          echo "Please fix these issues before merging."
          exit 1
        else
          echo "âœ… No high/critical SQL security issues found"
        fi
      else
        echo "âœ… No SQL files found to scan"
      fi
  artifacts:
    when: always
    paths:
      - sql-analysis-results/
    reports:
      junit: sql-analysis-results/scan-results.xml
    expire_in: 1 week
  coverage: '/Coverage: \d+\.\d+%/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - when: manual
      allow_failure: true

# ç®€åŒ–çš„SQLæ‰«æä½œä¸š
sql_scan_simple:
  stage: security
  dependencies:
    - install_dependencies
  script:
    - echo "ðŸ” Simple SQL Scan..."
    - npm run build
    - |
      # ç›´æŽ¥æ‰«æï¼Œå¤±è´¥æ—¶ä¸é˜»æ­¢æµæ°´çº¿
      if node dist/cli/index.js analyze ./sql --format json > sql-results.json 2>/dev/null; then
        echo "âœ… SQL scan completed"
      else
        echo "âš ï¸ SQL scan had issues"
        echo "ðŸ“Š Check artifacts for details"
      fi
  artifacts:
    when: always
    paths:
      - sql-results.json
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# åˆå¹¶è¯·æ±‚ä¸“ç”¨ä½œä¸š
mr_security_check:
  stage: security
  dependencies:
    - install_dependencies
  script:
    - echo "ðŸ” MR Security Check..."
    - echo "Analyzing changes since $CI_MERGE_REQUEST_TARGET_BRANCH_NAME..."

    # èŽ·å–å˜æ›´çš„SQLæ–‡ä»¶
    - |
      CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME...HEAD | grep -E "\.(sql|SQL)$" || echo "")
      echo "Changed SQL files: $CHANGED_FILES"

      if [ -n "$CHANGED_FILES" ]; then
        # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾å˜æ›´æ–‡ä»¶
        mkdir -p mr-scan
        for file in $CHANGED_FILES; do
          if [ -f "$file" ]; then
            mkdir -p mr-scan/$(dirname "$file")
            cp "$file" "mr-scan/$file"
          fi
        done

        # æ‰«æå˜æ›´çš„æ–‡ä»¶
        node dist/cli/index.js analyze mr-scan --format json > mr-scan-results.json

        # æ£€æŸ¥ç»“æžœ
        ISSUE_COUNT=$(node -e "
          const results = JSON.parse(require('fs').readFileSync('mr-scan-results.json', 'utf8'));
          const summary = results.scanInfo || {};
          console.log(summary.totalIssues || 0);
        ")

        echo "ðŸ“Š MR Scan Results:"
        echo "Total Issues: $ISSUE_COUNT"

        # åœ¨MRä¸­æ·»åŠ è¯„è®º
        if [ "$ISSUE_COUNT" -gt 0 ]; then
          echo "âŒ Found $ISSUE_COUNT SQL security issues in MR!"
          echo "Please review and fix before merging."
          exit 1
        else
          echo "âœ… No SQL security issues in MR"
        fi
      else
        echo "âœ… No SQL files changed in this MR"
      fi
  artifacts:
    when: always
    paths:
      - mr-scan-results.json
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# å®šæœŸå®‰å…¨æ‰«æï¼ˆå¯é€‰ï¼‰
scheduled_security_scan:
  stage: security
  dependencies:
    - install_dependencies
  script:
    - echo "ðŸ” Scheduled Security Scan..."
    - npm run build
    - node dist/cli/index.js analyze . --format json > scheduled-scan-results.json
    - echo "âœ… Scheduled scan completed"
  artifacts:
    when: always
    paths:
      - scheduled-scan-results.json
    expire_in: 2 weeks
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true