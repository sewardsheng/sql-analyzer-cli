#!/bin/bash
# Pre-commit hook for SQL Security Analysis
# åœ¨æ¯æ¬¡æäº¤å‰è‡ªåŠ¨æ‰«ææš‚å­˜çš„SQLæ–‡ä»¶

set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º

echo "ğŸ” Pre-commit SQL Security Check"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ£€æŸ¥SQL Analyzeræ˜¯å¦å¯ç”¨
check_sql_analyzer() {
    if ! command -v sql-analyzer &> /dev/null; then
        echo -e "${YELLOW}âš ï¸  SQL Analyzer CLI not found. Installing...${NC}"

        # æ£€æŸ¥æ˜¯å¦æœ‰npm
        if command -v npm &> /dev/null; then
            echo "Installing SQL Analyzer CLI via npm..."
            npm install -g sql-analyzer-cli
        else
            echo -e "${RED}âŒ npm not found. Please install SQL Analyzer CLI manually:${NC}"
            echo "npm install -g sql-analyzer-cli"
            exit 1
        fi
    fi
}

# è·å–æš‚å­˜çš„SQLæ–‡ä»¶
get_staged_sql_files() {
    # è·å–æš‚å­˜çš„SQLæ–‡ä»¶
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(sql|SQL)$" || echo "")

    if [ -z "$STAGED_FILES" ]; then
        echo -e "${GREEN}âœ… No SQL files staged for commit${NC}"
        exit 0
    fi

    echo "$STAGED_FILES"
}

# åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶å¤åˆ¶æš‚å­˜æ–‡ä»¶
setup_temp_directory() {
    TEMP_DIR=$(mktemp -d)
    echo "$TEMP_DIR"

    # å¤åˆ¶æš‚å­˜çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            mkdir -p "$TEMP_DIR/$(dirname "$file")"
            git show ":$file" > "$TEMP_DIR/$file"
        fi
    done
}

# è¿è¡ŒSQLåˆ†æ
run_sql_analysis() {
    local temp_dir=$1

    echo -e "${BLUE}ğŸ“‹ Staged SQL files:${NC}"
    echo "$STAGED_FILES" | tr '\n' ' '
    echo ""

    # åˆ›å»ºç»“æœç›®å½•
    RESULTS_DIR=$(mktemp -d)

    # è¿è¡ŒSQLåˆ†æ
    echo -e "${BLUE}ğŸ” Running SQL Security Analysis...${NC}"
    sql-analyzer analyze "$temp_dir" --format json > "$RESULTS_DIR/scan-results.json"

    # æ£€æŸ¥ç»“æœ
    if [ -f "$RESULTS_DIR/scan-results.json" ]; then
        echo -e "${BLUE}ğŸ“Š Analysis Results:${NC}"

        # ç»Ÿè®¡é—®é¢˜æ•°é‡
        TOTAL_ISSUES=$(node -e "
            const results = JSON.parse(require('fs').readFileSync('$RESULTS_DIR/scan-results.json', 'utf8'));
            const summary = results.scanInfo || {};
            console.log((summary.totalIssues || 0));
        ")

        CRITICAL_ISSUES=$(node -e "
            const results = JSON.parse(require('fs').readFileSync('$RESULTS_DIR/scan-results.json', 'utf8'));
            const summary = results.scanInfo || {};
            console.log((summary.issuesBySeverity?.critical || 0));
        ")

        HIGH_ISSUES=$(node -e "
            const results = JSON.parse(require('fs').readFileSync('$RESULTS_DIR/scan-results.json', 'utf8'));
            const summary = results.scanInfo || {};
            console.log((summary.issuesBySeverity?.high || 0));
        ")

        echo "Total Issues: $TOTAL_ISSUES"
        echo "Critical Issues: $CRITICAL_ISSUES"
        echo "High Issues: $HIGH_ISSUES"

        # æ˜¾ç¤ºè¯¦ç»†é—®é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
        if [ "$TOTAL_ISSUES" -gt 0 ]; then
            echo ""
            echo -e "${YELLOW}âš ï¸  Issues Found:${NC}"

            # ä½¿ç”¨jqæ˜¾ç¤ºé—®é¢˜è¯¦æƒ…ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if command -v jq &> /dev/null; then
                echo -e "${BLUE}ğŸ“„ Detailed Issues:${NC}"
                jq -r '.results[] | select(.issues | length > 0) | {
                    file: .file,
                    issues: [.issues[] | select(.severity == "critical" or .severity == "high")]
                } | select(.issues | length > 0) |
                "\(.file\): \(.issues | length\) issues" | jq -r '.'
            fi
        fi

        # æ£€æŸ¥æ˜¯å¦åº”è¯¥é˜»æ­¢æäº¤
        if [ "$CRITICAL_ISSUES" -gt 0 ]; then
            echo ""
            echo -e "${RED}âŒ CRITICAL SQL security issues found!${NC}"
            echo -e "${RED}Please fix all critical issues before committing.${NC}"
            echo ""
            echo -e "${BLUE}ğŸ’¡ Suggestions:${NC}"
            echo "1. Run 'sql-analyzer analyze --format console <file>' to see detailed issues"
            echo "2. Review SQL injection vulnerabilities"
            echo "3. Check for missing indexes and performance issues"
            echo "4. Follow SQL coding standards"

            # ä¿å­˜ç»“æœä¾›å‚è€ƒ
            cp "$RESULTS_DIR/scan-results.json" ./pre-commit-scan-results.json
            echo -e "${BLUE}ğŸ“„ Detailed results saved to: pre-commit-scan-results.json${NC}"

            rm -rf "$RESULTS_DIR"
            rm -rf "$temp_dir"
            exit 1
        elif [ "$HIGH_ISSUES" -gt 5 ]; then
            echo ""
            echo -e "${YELLOW}âš ï¸  Many high severity issues found ($HIGH_ISSUES)${NC}"
            echo -e "${YELLOW}Consider fixing these issues before committing.${NC}"
            echo ""
            read -p "Continue anyway? (y/N): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "Commit cancelled by user."
                rm -rf "$RESULTS_DIR"
                rm -rf "$temp_dir"
                exit 1
            fi
        else
            echo ""
            echo -e "${GREEN}âœ… SQL security check passed${NC}"
        fi

        rm -rf "$RESULTS_DIR"
    else
        echo -e "${RED}âŒ SQL analysis failed${NC}"
        rm -rf "$temp_dir"
        exit 1
    fi
}

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
cleanup() {
    if [ -n "$TEMP_DIR" ] && [ -d "$TEMP_DIR" ]; then
        rm -rf "$TEMP_DIR"
    fi
}

# è®¾ç½®æ¸…ç†é™·é˜±
trap cleanup EXIT

# ä¸»æµç¨‹
main() {
    # æ£€æŸ¥SQL Analyzer
    check_sql_analyzer

    # è·å–æš‚å­˜çš„SQLæ–‡ä»¶
    STAGED_FILES=$(get_staged_sql_files)

    if [ -z "$STAGED_FILES" ]; then
        echo -e "${GREEN}âœ… No SQL files to check${NC}"
        exit 0
    fi

    # è®¾ç½®ä¸´æ—¶ç›®å½•
    TEMP_DIR=$(setup_temp_directory)

    # è¿è¡Œåˆ†æ
    run_sql_analysis "$TEMP_DIR"
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"