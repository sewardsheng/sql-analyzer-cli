#!/bin/bash
# 简化的生产环境SQL安全检测Hook

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}🔒 生产环境SQL安全检查${NC}"
echo "========================================"

# 获取暂存的SQL文件
STAGED_SQL=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(sql|SQL)$" || true)

if [ -z "$STAGED_SQL" ]; then
    echo -e "${GREEN}✅ 没有SQL文件需要检查${NC}"
    exit 0
fi

echo -e "${BLUE}📁 检查暂存的SQL文件:${NC}"
for file in $STAGED_SQL; do
    echo "  - $file"
done

cd "$(git rev-parse --show-toplevel)"

# 检查tsx是否可用
if ! command -v tsx &> /dev/null; then
    echo -e "${YELLOW}⚠️  tsx未安装，正在安装...${NC}"
    npm install -g tsx
fi

echo -e "\n${BLUE}🔍 开始安全分析...${NC}"

HAS_CRITICAL_ISSUES=false
HAS_HIGH_ISSUES=false

# 检查每个文件
for file in $STAGED_SQL; do
    echo -e "\n${BLUE}📄 分析文件: $file${NC}"

    # 从暂存区获取文件内容
    TEMP_FILE="/tmp/$(basename "$file")"
    git show ":$file" > "$TEMP_FILE"

    # 使用简化的生产检测逻辑
    # 检测实际可执行代码中的严重问题

    # 1. 检测硬编码密码（排除注释）
    if grep -v "^\s*--" "$TEMP_FILE" | grep -q -i "password\s*=\s*'[^']*'"; then
        echo -e "  ${RED}🚨 检测到硬编码密码${NC}"
        HAS_CRITICAL_ISSUES=true
        continue
    fi

    # 2. 检测SQL注入（排除注释）
    if grep -v "^\s*--" "$TEMP_FILE" | grep -q "\+[ ]*'.*'" 2>/dev/null; then
        echo -e "  ${RED}🚨 检测到SQL注入风险${NC}"
        HAS_CRITICAL_ISSUES=true
        continue
    fi

    # 3. 检测无条件DELETE
    if grep -v "^\s*--" "$TEMP_FILE" | grep -qi "delete from [a-z_]*[ ;]"; then
        echo -e "  ${RED}🚨 检测到无条件删除操作${NC}"
        HAS_CRITICAL_ISSUES=true
        continue
    fi

    # 4. 检测无条件UPDATE
    if grep -v "^\s*--" "$TEMP_FILE" | grep -qi "^update [a-z_]* set [^;]*[ ;]"; then
        if ! grep -qi "where" "$TEMP_FILE"; then
            echo -e "  ${RED}🚨 检测到无条件更新操作${NC}"
            HAS_CRITICAL_ISSUES=true
            continue
        fi
    fi

    # 5. 检测SELECT *（高风险）
    if grep -v "^\s*--" "$TEMP_FILE" | grep -qi "select \* from"; then
        echo -e "  ${YELLOW}⚠️  检测到SELECT *（建议优化）${NC}"
        HAS_HIGH_ISSUES=true
    fi

    # 如果没有检测到问题
    if [ "$HAS_CRITICAL_ISSUES" = false ] && [ "$HAS_HIGH_ISSUES" = false ]; then
        echo -e "  ${GREEN}✅ 未检测到安全问题${NC}"
    fi

    rm -f "$TEMP_FILE"
done

echo -e "\n${BLUE}📊 最终分析结果:${NC}"

if [ "$HAS_CRITICAL_ISSUES" = true ]; then
    echo -e "\n${RED}"
    echo "╔══════════════════════════════════════╗"
    echo "║    🚫 提交被阻止 - 检测到严重安全问题     ║"
    echo "╚══════════════════════════════════════╝"
    echo -e "${NC}"
    echo -e "${RED}❌ 检测到严重SQL安全问题，提交被阻止！${NC}"
    echo ""
    echo -e "${YELLOW}发现的问题:${NC}"
    echo "  - 硬编码密码或密钥"
    echo "  - SQL注入漏洞"
    echo "  - 无条件的数据删除/更新"
    echo ""
    echo -e "${YELLOW}修复建议:${NC}"
    echo "  1. 使用参数化查询防止SQL注入"
    echo "  2. 通过环境变量管理敏感信息"
    echo "  3. 为所有数据操作添加WHERE条件"
    echo ""
    echo -e "${BLUE}紧急情况处理:${NC}"
    echo "  git commit --no-verify -m \"紧急提交说明\""
    echo ""
    echo -e "${RED}🔥 为了数据库安全，请修复这些问题后再提交！${NC}"
    exit 1

elif [ "$HAS_HIGH_ISSUES" = true ]; then
    echo -e "\n${YELLOW}⚠️  警告: 检测到高风险SQL问题${NC}"
    echo ""
    echo -e "${YELLOW}发现的问题:${NC}"
    echo "  - 性能优化建议（如避免SELECT *）"
    echo "  - 编码规范改进建议"
    echo ""
    echo -e "${YELLOW}虽然这些问题不会阻止提交，但建议修复以提升代码质量${NC}"
    echo ""
    read -p "是否继续提交? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}❌ 提交被取消${NC}"
        exit 1
    fi
    echo -e "${GREEN}✅ 继续提交${NC}"
    exit 0

else
    echo -e "\n${GREEN}"
    echo "╔══════════════════════════════════════╗"
    echo "║      ✅ 生产环境SQL安全检查通过      ║"
    echo "╚══════════════════════════════════════╝"
    echo -e "${NC}"
    echo -e "${GREEN}🎉 恭喜！您的SQL代码符合生产环境安全标准${NC}"
    echo -e "${GREEN}   可以安全地提交到代码库${NC}"
    exit 0
fi