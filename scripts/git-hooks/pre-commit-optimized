#!/bin/bash
# ä¼˜åŒ–çš„ç”Ÿäº§ç¯å¢ƒSQLå®‰å…¨æ£€æµ‹Hook
# è§£å†³è¾¹ç¼˜æƒ…å†µå’Œè¯¯æŠ¥é—®é¢˜

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

echo -e "${BLUE}ğŸ”’ ä¼˜åŒ–ç‰ˆç”Ÿäº§ç¯å¢ƒSQLå®‰å…¨æ£€æŸ¥${NC}"
echo "========================================"

# è·å–æš‚å­˜çš„SQLæ–‡ä»¶
STAGED_SQL=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(sql|SQL)$" || true)

if [ -z "$STAGED_SQL" ]; then
    echo -e "${GREEN}âœ… æ²¡æœ‰SQLæ–‡ä»¶éœ€è¦æ£€æŸ¥${NC}"
    exit 0
fi

echo -e "${BLUE}ğŸ“ æ£€æŸ¥æš‚å­˜çš„SQLæ–‡ä»¶:${NC}"
for file in $STAGED_SQL; do
    echo "  - $file"
done

cd "$(git rev-parse --show-toplevel)"

# æ£€æŸ¥tsxæ˜¯å¦å¯ç”¨
if ! command -v tsx &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  tsxæœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…...${NC}"
    npm install -g tsx
fi

echo -e "\n${BLUE}ğŸ” å¼€å§‹ä¼˜åŒ–ç‰ˆå®‰å…¨åˆ†æ...${NC}"

HAS_CRITICAL_ISSUES=false
HAS_HIGH_ISSUES=false

# ä¼˜åŒ–çš„é¢„å¤„ç†å‡½æ•°
preprocess_sql_file() {
    local input_file="$1"
    local output_file="$2"

    # ä½¿ç”¨sedè¿›è¡Œæ›´ç²¾ç¡®çš„æ³¨é‡Šè¿‡æ»¤
    sed '
        # åˆ é™¤å•è¡Œæ³¨é‡Š
        /^[[:space:]]*--/d

        # åˆ é™¤å¤šè¡Œæ³¨é‡Š /* ... */
        /\/\*/,/\*\//d

        # åˆ é™¤ç©ºè¡Œ
        /^[[:space:]]*$/d
    ' "$input_file" > "$output_file"
}

# ä¼˜åŒ–çš„ç¡¬ç¼–ç å¯†ç æ£€æµ‹
detect_hardcoded_passwords() {
    local file="$1"
    local line_num="$2"

    # æ›´ç²¾ç¡®çš„ç¡¬ç¼–ç å¯†ç æ£€æµ‹
    if echo "$file" | grep -qi "password\s*=\s*'[^']*'" && ! echo "$file" | grep -qi "password_hash\|password_token\|password_reset"; then
        echo -e "  ${RED}ğŸš¨ æ£€æµ‹åˆ°ç¡¬ç¼–ç å¯†ç ${NC}"
        echo -e "    ${YELLOW}ç¬¬${line_num}è¡Œ: $(echo "$file" | head -1)${NC}"
        return 0
    fi

    # æ£€æŸ¥å…¶ä»–æ•æ„Ÿå‡­è¯
    if echo "$file" | grep -qi "secret\s*=\s*'[^']*'" || echo "$file" | grep -qi "key\s*=\s*'[^']*'" && ! echo "$file" | grep -qi "key_hash\|key_token\|encryption_key"; then
        echo -e "  ${RED}ğŸš¨ æ£€æµ‹åˆ°ç¡¬ç¼–ç å‡­è¯${NC}"
        echo -e "    ${YELLOW}ç¬¬${line_num}è¡Œ: $(echo "$file" | head -1)${NC}"
        return 0
    fi

    return 1
}

# ä¼˜åŒ–çš„SQLæ³¨å…¥æ£€æµ‹
detect_sql_injection() {
    local file="$1"
    local line_num="$2"

    # æ›´ç²¾ç¡®çš„SQLæ³¨å…¥æ£€æµ‹
    # æ£€æµ‹å®é™…çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæ’é™¤å‡½æ•°è°ƒç”¨å’Œè¿æ¥æ“ä½œ
    if echo "$file" | grep -qiE "where\s+[^=]*\s*=\s*'[^']*'\s*\+[^\s;]+"; then
        echo -e "  ${RED}ğŸš¨ æ£€æµ‹åˆ°SQLæ³¨å…¥é£é™©${NC}"
        echo -e "    ${YELLOW}ç¬¬${line_num}è¡Œ: $(echo "$file" | head -1)${NC}"
        return 0
    fi

    # æ£€æµ‹å­—ç¬¦ä¸²æ‹¼æ¥åœ¨WHEREæ¡ä»¶ä¸­
    if echo "$file" | grep -qiE "select.*from.*where.*\+.*'" || echo "$file" | grep -qiE "delete.*from.*where.*\+.*'"; then
        echo -e "  ${RED}ğŸš¨ æ£€æµ‹åˆ°SQLæ³¨å…¥é£é™©${NC}"
        echo -e "    ${YELLOW}ç¬¬${line_num}è¡Œ: $(echo "$file" | head -1)${NC}"
        return 0
    fi

    return 1
}

# ä¼˜åŒ–çš„æ— æ¡ä»¶æ“ä½œæ£€æµ‹
detect_unconditional_operations() {
    local file="$1"
    local line_num="$2"

    # ç²¾ç¡®æ£€æµ‹æ— æ¡ä»¶DELETEï¼ˆæ²¡æœ‰WHEREå­å¥ï¼‰
    if echo "$file" | grep -qiE "^\s*delete\s+from\s+[a-z_][a-z0-9_]*\s*;?\s*$"; then
        echo -e "  ${RED}ğŸš¨ æ£€æµ‹åˆ°æ— æ¡ä»¶åˆ é™¤æ“ä½œ${NC}"
        echo -e "    ${YELLOW}ç¬¬${line_num}è¡Œ: $(echo "$file" | head -1)${NC}"
        return 0
    fi

    # ç²¾ç¡®æ£€æµ‹æ— æ¡ä»¶UPDATEï¼ˆæ²¡æœ‰WHEREå­å¥ï¼‰
    if echo "$file" | grep -qiE "^\s*update\s+[a-z_][a-z0-9_]*\s+set\s+[^;]+;?\s*$"; then
        if ! echo "$file" | grep -qi "where"; then
            echo -e "  ${RED}ğŸš¨ æ£€æµ‹åˆ°æ— æ¡ä»¶æ›´æ–°æ“ä½œ${NC}"
            echo -e "    ${YELLOW}ç¬¬${line_num}è¡Œ: $(echo "$file" | head -1)${NC}"
            return 0
        fi
    fi

    return 1
}

# é«˜é£é™©æ“ä½œæ£€æµ‹
detect_high_risk_operations() {
    local file="$1"
    local line_num="$2"

    # æ£€æµ‹SELECT *ï¼ˆæ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­é£é™©ï¼‰
    if echo "$file" | grep -qi "select\s+\*\s+from"; then
        # æ£€æŸ¥æ˜¯å¦æ¶‰åŠæ•æ„Ÿè¡¨
        if echo "$file" | grep -qiE "from\s+(users|user_|customer|admin|password|credit|bank|payment)"; then
            echo -e "  ${YELLOW}âš ï¸  æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯æŸ¥è¯¢ï¼ˆå»ºè®®é¿å…SELECT *ï¼‰${NC}"
            echo -e "    ${YELLOW}ç¬¬${line_num}è¡Œ: $(echo "$file" | head -1)${NC}"
            return 0
        fi
    fi

    return 1
}

# æ£€æŸ¥æ¯ä¸ªæ–‡ä»¶
for file in $STAGED_SQL; do
    echo -e "\n${BLUE}ğŸ“„ åˆ†ææ–‡ä»¶: $file${NC}"

    # ä»æš‚å­˜åŒºè·å–æ–‡ä»¶å†…å®¹
    TEMP_FILE="/tmp/$(basename "$file").preprocessed"
    git show ":$file" > "/tmp/$(basename "$file").original"

    # é¢„å¤„ç†SQLæ–‡ä»¶
    preprocess_sql_file "/tmp/$(basename "$file").original" "$TEMP_FILE"

    if [ ! -s "$TEMP_FILE" ]; then
        echo -e "  ${GREEN}âœ… æ–‡ä»¶åªåŒ…å«æ³¨é‡Šï¼Œè·³è¿‡æ£€æŸ¥${NC}"
        rm -f "/tmp/$(basename "$file").original" "$TEMP_FILE"
        continue
    fi

    # é€è¡Œåˆ†æé¢„å¤„ç†åçš„æ–‡ä»¶
    line_num=1
    while IFS= read -r line; do
        # æ£€æµ‹ç¡¬ç¼–ç å¯†ç 
        if detect_hardcoded_passwords "$line" "$line_num"; then
            HAS_CRITICAL_ISSUES=true
            break
        fi

        # æ£€æµ‹SQLæ³¨å…¥
        if detect_sql_injection "$line" "$line_num"; then
            HAS_CRITICAL_ISSUES=true
            break
        fi

        # æ£€æµ‹æ— æ¡ä»¶æ“ä½œ
        if detect_unconditional_operations "$line" "$line_num"; then
            HAS_CRITICAL_ISSUES=true
            break
        fi

        # æ£€æµ‹é«˜é£é™©æ“ä½œ
        if detect_high_risk_operations "$line" "$line_num"; then
            HAS_HIGH_ISSUES=true
        fi

        ((line_num++))
    done < "$TEMP_FILE"

    # å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°é—®é¢˜
    if [ "$HAS_CRITICAL_ISSUES" = false ] && [ "$HAS_HIGH_ISSUES" = false ]; then
        echo -e "  ${GREEN}âœ… æœªæ£€æµ‹åˆ°å®‰å…¨é—®é¢˜${NC}"
    fi

    rm -f "/tmp/$(basename "$file").original" "$TEMP_FILE"
done

echo -e "\n${BLUE}ğŸ“Š æœ€ç»ˆåˆ†æç»“æœ:${NC}"

if [ "$HAS_CRITICAL_ISSUES" = true ]; then
    echo -e "\n${RED}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘    ğŸš« æäº¤è¢«é˜»æ­¢ - æ£€æµ‹åˆ°ä¸¥é‡å®‰å…¨é—®é¢˜     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo -e "${RED}âŒ æ£€æµ‹åˆ°ä¸¥é‡SQLå®‰å…¨é—®é¢˜ï¼Œæäº¤è¢«é˜»æ­¢ï¼${NC}"
    echo ""
    echo -e "${YELLOW}å‘ç°çš„é—®é¢˜:${NC}"
    echo "  - ç¡¬ç¼–ç å¯†ç æˆ–å¯†é’¥"
    echo "  - SQLæ³¨å…¥æ¼æ´"
    echo "  - æ— æ¡ä»¶çš„æ•°æ®åˆ é™¤/æ›´æ–°"
    echo ""
    echo -e "${YELLOW}ä¿®å¤å»ºè®®:${NC}"
    echo "  1. ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥"
    echo "  2. é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯"
    echo "  3. ä¸ºæ‰€æœ‰æ•°æ®æ“ä½œæ·»åŠ WHEREæ¡ä»¶"
    echo ""
    echo -e "${BLUE}ç´§æ€¥æƒ…å†µå¤„ç†:${NC}"
    echo "  git commit --no-verify -m \"ç´§æ€¥æäº¤è¯´æ˜\""
    echo ""
    echo -e "${RED}ğŸ”¥ ä¸ºäº†æ•°æ®åº“å®‰å…¨ï¼Œè¯·ä¿®å¤è¿™äº›é—®é¢˜åå†æäº¤ï¼${NC}"
    exit 1

elif [ "$HAS_HIGH_ISSUES" = true ]; then
    echo -e "\n${YELLOW}âš ï¸  è­¦å‘Š: æ£€æµ‹åˆ°é«˜é£é™©SQLé—®é¢˜${NC}"
    echo ""
    echo -e "${YELLOW}å‘ç°çš„é—®é¢˜:${NC}"
    echo "  - æ•æ„Ÿä¿¡æ¯æŸ¥è¯¢ä¼˜åŒ–å»ºè®®"
    echo "  - æ€§èƒ½ä¼˜åŒ–å»ºè®®"
    echo ""
    echo -e "${YELLOW}è™½ç„¶è¿™äº›é—®é¢˜ä¸ä¼šé˜»æ­¢æäº¤ï¼Œä½†å»ºè®®å°½å¿«ä¿®å¤ä»¥æå‡ä»£ç è´¨é‡${NC}"
    echo ""
    read -p "æ˜¯å¦ç»§ç»­æäº¤? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}âŒ æäº¤è¢«å–æ¶ˆ${NC}"
        exit 1
    fi
    echo -e "${GREEN}âœ… ç»§ç»­æäº¤${NC}"
    exit 0

else
    echo -e "\n${GREEN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘      âœ… ç”Ÿäº§ç¯å¢ƒSQLå®‰å…¨æ£€æŸ¥é€šè¿‡      â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    echo -e "${GREEN}ğŸ‰ æ­å–œï¼æ‚¨çš„SQLä»£ç ç¬¦åˆç”Ÿäº§ç¯å¢ƒå®‰å…¨æ ‡å‡†${NC}"
    echo -e "${GREEN}   å¯ä»¥å®‰å…¨åœ°æäº¤åˆ°ä»£ç åº“${NC}"
    exit 0
fi