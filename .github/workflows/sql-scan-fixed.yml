name: SQL Scan (Fixed)

on: [push, pull_request]

jobs:
  sql-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Install tsx globally (for running TypeScript)
      run: npm install -g tsx

    - name: Run SQL Analyzer
      run: |
        # 查找SQL文件
        SQL_FILES=$(find . -name "*.sql" -not -path "./node_modules/*" 2>/dev/null || echo "")

        if [ -n "$SQL_FILES" ]; then
          echo "Found SQL files, running analysis..."

          # 创建临时目录存放纯净的JSON输出
          mkdir -p temp-results

          # 扫描每个SQL文件，保存纯净的JSON结果
          for file in $SQL_FILES; do
            echo "Analyzing: $file"
            filename=$(basename "$file" .sql)

            # 使用tsx直接运行，过滤掉console输出只保留JSON
            tsx src/cli/index.ts analyze --file "$file" --json 2>/dev/null | \
            sed '1,/^{/d' | sed '/^}/!d;$d' > "temp-results/${filename}.json" || true
          done

          # 合并所有结果并检查严重问题
          echo "Checking for critical issues..."
          CRITICAL_COUNT=0

          for result in temp-results/*.json; do
            if [ -f "$result" ] && [ -s "$result" ]; then
              # 检查是否包含严重安全问题
              if grep -q "critical\|SQL注入\|硬编码密码" "$result"; then
                echo "❌ Critical issues found in $(basename "$result")"
                CRITICAL_COUNT=$((CRITICAL_COUNT + 1))
              fi
            fi
          done

          # 上传结果
          if [ "$(ls -A temp-results/)" ]; then
            echo "Uploading scan results..."

            # 创建合并报告
            echo '{"scanResults": [' > results.json
            first=true
            for result in temp-results/*.json; do
              if [ -f "$result" ] && [ -s "$result" ]; then
                if [ "$first" = false ]; then
                  echo ',' >> results.json
                fi
                cat "$result" >> results.json
                first=false
              fi
            done
            echo ']}' >> results.json
          fi

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "❌ Found $CRITICAL_COUNT files with critical SQL issues!"
            echo "Please fix these issues before merging."
            exit 1
          else
            echo "✅ No critical SQL issues found"
          fi
        else
          echo "No SQL files found to scan"
        fi

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sql-scan-results
        path: results.json
        retention-days: 30