name: SQL Scan (Simple)

on: [push, pull_request]

jobs:
  sql-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Install tsx for TypeScript execution
      run: npm install -g tsx

    - name: Run SQL Analyzer
      run: |
        # 查找SQL文件
        SQL_FILES=$(find . -name "*.sql" -not -path "./node_modules/*" 2>/dev/null || echo "")

        if [ -n "$SQL_FILES" ]; then
          echo "Found SQL files, running analysis..."
          # 使用tsx直接运行TypeScript代码
          tsx src/cli/index.ts analyze --file test-sql-for-ci.sql --json > results.json 2>/dev/null || echo "{}" > results.json

          # 检查是否有严重问题
          HIGH_ISSUES=$(node -e "
            const results = JSON.parse(require('fs').readFileSync('results.json', 'utf8'));
            const summary = results.scanInfo || {};
            console.log((summary.issuesBySeverity?.high || 0) + (summary.issuesBySeverity?.critical || 0));
          ")

          if [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "❌ Found $HIGH_ISSUES high/critical SQL issues!"
            exit 1
          else
            echo "✅ No high/critical SQL issues found"
          fi
        else
          echo "No SQL files found to scan"
        fi

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sql-scan-results
        path: results.json