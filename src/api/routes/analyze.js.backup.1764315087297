/**
 * SQL分析路由模块
 * 使用新的SQLAnalyzer
 */

import { sqlAnalyzer } from '../../core/index.js';
import { createValidationError } from '../../utils/api/api-error.js';
import { formatSuccessResponse, formatErrorResponse } from '../../utils/api/response-formatter.js';
import { config } from '../../config/index.js';
import { warn as logWarn, error as logError, LogCategory } from '../../utils/logger.js';

// 从配置管理器获取学习配置
function getLearningConfig() {
  return config.getRuleLearningConfig();
}

/**
 * 注册分析相关路由
 * @param {Object} app - Hono应用实例
 */
export function registerAnalyzeRoutes(app) {
  /**
   * POST /api/analyze - SQL分析接口
   * 分析单条SQL语句
   */
  app.post('/api/analyze', async (c) => {
    const startTime = Date.now();
    
    try {
      const body = await c.req.json();
      
      // 验证请求体
      if (!body.sql || typeof body.sql !== 'string') {
        throw createValidationError('请求体必须包含 "sql" 字段，且为字符串类型');
      }
      
      const sqlQuery = body.sql.trim();
      if (!sqlQuery) {
        throw createValidationError('SQL语句不能为空');
      }
      
      // 准备分析选项
      const options = {
        performance: body.options?.performance !== false,
        security: body.options?.security !== false,
        standards: body.options?.standards !== false
      };
      
      console.log(`[API] 收到分析请求: ${sqlQuery.substring(0, 50)}...`);
      
      // 执行SQL分析
      const result = await sqlAnalyzer.analyze(sqlQuery, options);
      
      const responseTime = Date.now() - startTime;
      console.log(`[API] 分析完成，用时: ${responseTime}ms`);
      
      // 异步历史记录保存 + 智能规则学习 - 不阻塞响应
      setImmediate(async () => {
        try {
          const { getHistoryService } = await import('../../services/history-service.js');
          const historyService = await getHistoryService();
          
          // 保存历史记录
          const recordId = await historyService.saveAnalysis({
            sql: sqlQuery,
            result: result,
            type: 'command'
          });
          
          // 触发智能规则学习（如果启用且有高质量分析结果）
          if (body.options?.learn !== false && result.success) {
            const config = getLearningConfig();
            
            if (config.learning?.enabled) {
              const avgConfidence = calculateAverageConfidence(result);
              const minConfidence = config.learning?.minConfidence ?? 0.7;
              
              // 只对高质量分析结果进行学习
              if (avgConfidence >= minConfidence) {
                try {
                  const { getIntelligentRuleLearner } = await import('../../services/rule-learning/rule-learner.js');
                  const { getLLMService } = await import('../../core/llm-service.js');
                  
                  const ruleLearner = getIntelligentRuleLearner(getLLMService(), historyService);
                  
                  // 异步执行规则学习，不阻塞主流程
                  ruleLearner.learnFromAnalysis(result, sqlQuery).catch(error => {
                    logWarn(LogCategory.RULE_LEARNING, `规则学习失败: ${error.message}`, { sql: sqlQuery, error: error.stack });
                  });
                } catch (learnError) {
                  logError(LogCategory.RULE_LEARNING, `规则学习初始化失败: ${learnError.message}`, learnError, { sql: sqlQuery });
                }
              }
            }
          }
          
          console.log(`[API] 历史记录已保存，ID: ${recordId}`);
        } catch (historyError) {
          logError(LogCategory.HISTORY, `异步保存失败: ${historyError.message}`, historyError, { sql: sqlQuery });
        }
      });
      
      // 使用响应格式化工具
      return c.json(formatSuccessResponse(result.data, {
        ...result.metadata,
        responseTime
      }));
      
    } catch (error) {
      const responseTime = Date.now() - startTime;
      console.error(`[API] 分析失败: ${error.message}`);
      
      // 返回错误响应
      return c.json(formatErrorResponse(error.message, {
        responseTime,
        timestamp: new Date().toISOString()
      }), 400);
    }
  });

  /**
   * POST /api/analyze/batch - 批量SQL分析接口
   * 分析多条SQL语句
   */
  app.post('/api/analyze/batch', async (c) => {
    const startTime = Date.now();
    
    try {
      const body = await c.req.json();
      
      // 验证请求体
      if (!body.sqls || !Array.isArray(body.sqls) || body.sqls.length === 0) {
        throw createValidationError('请求体必须包含 "sqls" 数组字段，且不能为空');
      }
      
      if (body.sqls.length > 50) {
        throw createValidationError('批量分析最多支持50条SQL语句');
      }
      
      // 准备分析选项
      const options = {
        performance: body.options?.performance !== false,
        security: body.options?.security !== false,
        standards: body.options?.standards !== false
      };
      
      console.log(`[API] 收到批量分析请求，共 ${body.sqls.length} 条SQL`);
      
      // 使用新的批量分析方法
      const results = await sqlAnalyzer.analyzeBatch(
        body.sqls.map(item => item.sql || item),
        options
      );
      
      const responseTime = Date.now() - startTime;
      const succeeded = results.filter(r => r.success).length;
      const failed = results.length - succeeded;
      
      console.log(`[API] 批量分析完成，用时: ${responseTime}ms，成功: ${succeeded}，失败: ${failed}`);
      
      // 异步批量历史记录保存 + 智能规则学习 - 不阻塞响应
      setImmediate(async () => {
        try {
          const { getHistoryService } = await import('../../services/history-service.js');
          const historyService = await getHistoryService();
          
          // 为每条成功的SQL保存历史记录
          for (const result of results) {
            if (result.success && result.sql) {
              try {
                await historyService.saveAnalysis({
                  sql: result.sql,
                  result: result,
                  type: 'batch'
                });
                
                // 触发智能规则学习（如果启用）
                if (body.options?.learn !== false) {
                  const config = getLearningConfig();
                  
                  if (config.learning?.enabled) {
                    const avgConfidence = calculateAverageConfidence(result);
                    const minConfidence = config.learning?.minConfidence ?? 0.7;
                    
                    if (avgConfidence >= minConfidence) {
                      try {
                        const { getIntelligentRuleLearner } = await import('../../services/rule-learning/rule-learner.js');
                        const { getLLMService } = await import('../../core/llm-service.js');
                        
                        const ruleLearner = getIntelligentRuleLearner(getLLMService(), historyService);
                        
                        // 异步执行规则学习
                        ruleLearner.learnFromAnalysis(result, result.sql).catch(error => {
                          logWarn(LogCategory.RULE_LEARNING, `批量规则学习失败: ${error.message}`, { sql: result.sql, error: error.stack });
                        });
                      } catch (learnError) {
                        logError(LogCategory.RULE_LEARNING, `批量规则学习初始化失败: ${learnError.message}`, learnError);
                      }
                    }
                  }
                }
              } catch (err) {
                logError(LogCategory.HISTORY, `异步保存批量历史记录失败: ${err.message}`, err);
              }
            }
          }
          
          console.log(`[API] 批量历史记录已异步保存: ${succeeded} 条`);
        } catch (historyError) {
          logError(LogCategory.HISTORY, `异步保存批量历史记录失败: ${historyError.message}`, historyError);
        }
      });
      
      // 使用响应格式化工具
      return c.json(formatSuccessResponse(results, {
        total: results.length,
        succeeded,
        failed,
        responseTime,
        timestamp: new Date().toISOString()
      }));
      
    } catch (error) {
      const responseTime = Date.now() - startTime;
      console.error(`[API] 批量分析失败: ${error.message}`);
      
      // 返回错误响应
      return c.json(formatErrorResponse(error.message, {
        responseTime,
        timestamp: new Date().toISOString()
      }), 400);
    }
  });

  /**
   * GET /api/analyze/status - 获取分析器状态
   */
  app.get('/api/analyze/status', async (c) => {
    try {
      const status = sqlAnalyzer.getStatus();
      
      return c.json(formatSuccessResponse(status, {
        timestamp: new Date().toISOString()
      }));
      
    } catch (error) {
      console.error(`[API] 获取状态失败: ${error.message}`);
      
      return c.json(formatErrorResponse(error.message, {
        timestamp: new Date().toISOString()
      }), 500);
    }
  });
}

/**
 * 计算平均置信度
 * @param {Object} analysisResult - 分析结果
 * @returns {number} 平均置信度
 */
function calculateAverageConfidence(analysisResult) {
  const confidences = [];
  
  if (analysisResult.data?.performance?.metadata?.confidence) {
    confidences.push(analysisResult.data.performance.metadata.confidence);
  }
  if (analysisResult.data?.security?.metadata?.confidence) {
    confidences.push(analysisResult.data.security.metadata.confidence);
  }
  if (analysisResult.data?.standards?.metadata?.confidence) {
    confidences.push(analysisResult.data.standards.metadata.confidence);
  }
  
  return confidences.length > 0
    ? confidences.reduce((sum, conf) => sum + conf, 0) / confidences.length
    : 0;
}